using System.Runtime.Serialization;
using MFiles.VAF;
using MFiles.VAF.Common;
using MFiles.VAF.AdminConfigurations;
using MFilesAPI;
using Newtonsoft.Json;
using System;
using System.Diagnostics;
using MFiles.VAF.Configuration.Domain.Dashboards;
using System.Xml.Serialization;
using System.IO;
using System.Data.SqlClient;
using System.Data;
using MFiles.VAF.Configuration;

namespace ContextMenuVaultApp
{
    /// <summary>
    /// Simple configuration.
    /// </summary>
    /// 


    /// <summary>
    /// Simple vault application to demonstrate VAF.
    /// </summary>
    public class VaultApplication : VaultApplicationBase, IUsesAdminConfigurations
    {
        string Result = string.Empty, StrSelectedObjInput = string.Empty, StrInputs = string.Empty;
        string ConnectionStr = string.Empty;
        EventHandlerEnvironment envNew;
        [MFConfiguration("MFSQLVaultApp", "config")]
        private Configuration _config = new Configuration();
        private ConfigurationNode<Configuration> config { get; set; }

        string VaultName = string.Empty;

        string DatabaseName { get; set; }
        public VaultApplication()
        {
            try
            {
                // Set up the license decoder.
                var licenseDecoder = new MFiles.VAF.Configuration.LicenseDecoder(MFiles.VAF.Configuration.LicenseDecoder.EncMode.TwoKey);
                // This is from the key file (MainKey.PublicXml).
                licenseDecoder.MainKey = "<RSAKeyValue><Modulus>x/LJ8KGT9EECGFeYAc+MR2zWd5LiHtzPpaGifdbFqnXAUFx7VOC3kwzMYwvJn1yD/K6I+PPUvDGV75gZsIwmDafLb6L2cAVkY3bKl923jJDnYeZ/Xg3umSQCkmPhGQKq2Xx4W/8O7HgUuxXNQyJ4ZhqItF9DpzWqCW1V4kYq39U=</Modulus><Exponent>AQAB</Exponent></RSAKeyValue>";
                // This is from the key file (SecondKey.SecretXml)
                licenseDecoder.AltKey = "<RSAKeyValue><Modulus>ymeorpHJf8L+BD9wnODAdQEYy7fSenYG7GlKdtuECUt8rU24aLgZ1Bhw8G1+DXnYajtkOTyV/ah3RbYjF7JgWmVQbztVEZ8WYyEofkrGFo+zCtbhTN11VENxlK1Y7VxxyCaK1mTRTRHKqJywQBHLSZMjJk6jBapl+sfWYhZjdQk=</Modulus><Exponent>AQAB</Exponent><P>/E/L2diRwA8a9VF3Aupy37ynGoTREbnXYq7Aiza734NZlAYzxPcY5xBrmhyaHgaQ8xpgDxZYS6AHuU8WrLBpLQ==</P><Q>zV0Z01G5PQc9OvdBK6+ddCgx5SOlsQV72zCoCRO74q8QsQUZKhnJuNlIwIvDhB/UoGrMs02C9cVGV514j2mszQ==</Q><DP>KTiUMlQKg9kz605S5jwNZnY4ysFWMtIs2Sd5t4TKrtqTwPY+cPh5rg5ltfjkSPGDruPpO63H4RsVB/Ze2vm7RQ==</DP><DQ>C01/eWD7F//I//DR1myw9s6riFgA65BIs9SmuvEqGxzVh1infOi0cIcM+QP4O9Jgqn+WSpwOhCZaa8IP+5yuVQ==</DQ><InverseQ>17b/SYWRGvb/De5sfH/DRWXrefK6BJpLzXXxLjrOsiAiAPjooc1emkoy5+0v9wzyBlGycCRC8SBKX/leLb9BZA==</InverseQ><D>BtLfnO/nhlsvrKjqcYyrOF/A/EmIn5TySnN3SPbl1DTSMZ+vDTh22HRMWQUAjNDUHnPh7Kej/r7dIR0RCgWWmgUBiovEfn2iwjurU6kKjjTRB3h9OpXJ4NKVS3PxzXUe2Gw8QNJgEQ/FlFn4iriWD+5xemLDgkIzNDrgA/odx30=</D></RSAKeyValue>";
                this.License = new LicenseManagerBase<MFiles.VAF.Configuration.LicenseContentBase>(licenseDecoder);
            }
            catch (Exception ex)
            {
                SysUtils.ReportErrorToEventLog(this.EventSourceIdentifier,
                ex.Message);
            }
        }

        int CommandtimeOut = 14400;




        public void InitializeAdminConfigurations(IAdminConfigurations adminConfigurations)

        {
            // Add it to the configuration screen.
            this.config = adminConfigurations.AddSimpleConfigurationNode<Configuration>("MFSQL Connector VaultApp", this.DashboardGenerator);
            this.config.Validator = this.CustomValidator;
            this.config.Changed += (oldConfig, newConfig) =>
            {
                //After chnaging configuration values code goes here.
            };
        }

        private System.Collections.Generic.IEnumerable<ValidationFinding> CustomValidator(Configuration configuration)
        {
           
            ValidationFinding finding = null;
            try
            {
                // Connect to the database to test the connection is valid.
                using (var sqlConnection = new System.Data.SqlClient.SqlConnection(GetConnectionString()))
                {
                    // Connect to the database.
                    sqlConnection.Open();
                    // If no exception then report okay.
                    finding = new MFiles.VAF.Configuration.ValidationFinding(
                                                                              MFiles.VAF.Configuration.ValidationFindingType.Ok,
                                                                              "ConnnectionString",
                                                                              "Connection successful"
                                                                             );
                    // Disconnect.
                    sqlConnection.Close();
                }
            }
            catch (Exception e)
            {
                // Report an exception.
                finding = new ValidationFinding(ValidationFindingType.Error, "ConnectionString", $"Exception connecting to server: {e.Message}");
            }
            // Return the finding.
            yield return finding;
        }
        public void CheckLicenseStatus()
        {
            // Evaluate the license validity.
            //this.License.Evaluate(vaultPersistent, false);

            string ModuleValues = string.Empty;



            // Output the license status.
            switch (this.License.LicenseStatus)
            {
                case MFApplicationLicenseStatus.MFApplicationLicenseStatusTrial:
                    {
                        SysUtils.ReportToEventLog(
                        "Application is running in a trial mode.",
                        System.Diagnostics.EventLogEntryType.Warning);


                        string LicenseExpiryDate = this.License.Content<MFiles.VAF.Configuration.LicenseContentBase>().LicenseExpireDate;


                        ModuleValues = GetModules();

                        UpdateMFModule(ModuleValues, VaultName, LicenseExpiryDate, GetConnectionString());
                        break;
                    }
                case MFApplicationLicenseStatus.MFApplicationLicenseStatusValid:
                    {
                        SysUtils.ReportInfoToEventLog(
                        "Application is licensed.");



                        string LicenseExpiryDate = this.License.Content<MFiles.VAF.Configuration.LicenseContentBase>().LicenseExpireDate;

                        ModuleValues = GetModules();

                        UpdateMFModule(ModuleValues, VaultName, LicenseExpiryDate, GetConnectionString());
                        break;
                    }
                default:
                    {
                        SysUtils.ReportToEventLog(
                        $"Application is in an unexpected state: { this.License.LicenseStatus}.", EventLogEntryType.Error);
                        break;
                    }
            }
        }

        private string DashboardGenerator()

        {

            string Path = System.IO.Path.GetDirectoryName(Environment.GetCommandLineArgs()[0]);
            //System.IO.Path.GetDirectoryName(Process.GetCurrentProcess().MainModule.FileName)
            Path = "CAP Badge - Premier(1).jpg";

            var image = DashboardHelper.ImageFileToDataUri(Path);
            var Logo = DashboardHelper.ImageFileToDataUri("logo-color(1).png");
            // return "$< div style = 'background-image: url(" + Logo + ");height:50px;display:block; margin-left:auto;margin-right: auto;width:15%; ' ></ div >< div style = 'height:50px;display:block; margin-left:auto;margin-right: auto;width:40%;font-family:Calibri Light (Headings);font-size: 16px;color:#2f5496' > &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MFSQL Database File Connector</ div >< br />< div style = 'color:black;font-family:Calibri (Body);font-size: 11px;' > The MFSQL Database File Connector is part of the MFSQL Connector suite.The Connector allows the user to browse and search in M - files to file that is saved in SQL Blobs in a SQL Table.< br />< br /> < br /> Connections : < br /></ div >< br />< br />< br />< div style = 'background-image: url(" + image + ");height:130px;display:block; margin-left:auto;margin-right: auto;width:50%; ' ></ div > ";


            String Title = string.Empty;
            String Description = string.Empty;
            String HelpLink = string.Empty;
            String Helptext = string.Empty;

            string modules = GetModules();
            string[] ModulesList = null;
            if (!string.IsNullOrEmpty(modules) && modules.Length > 0)
                ModulesList = modules.Split(',');

            string ModulesHtml = string.Empty;

            ModulesHtml += "<ul>";

            if (ModulesList != null && ModulesList.Length > 0)
            {
                foreach (var item in ModulesList)
                {

                    ModulesHtml += "<li>";
                    ModulesHtml += (Enum.Modules)Convert.ToInt32(item);
                    ModulesHtml += "</li>";
                }
            }

            ModulesHtml += "</ul>";

            Menu menu = new Menu();




            DataTable dtConfigurationSettings = menu.GetData("spMfGetSettingsForCofigurator", GetConnectionString());

            string mfSqlConnectorVersion = string.Empty;
            string assemblyInstallationFolder = string.Empty;
            string fileExportFolderFromSQLServer = string.Empty;
            string fileImportFolderFromSQLServer = string.Empty;
            string mFilesClientInstallationVersionOnSQLServer = string.Empty;

            if (dtConfigurationSettings.Rows.Count > 0)
            {
                mfSqlConnectorVersion = (dtConfigurationSettings.Rows[0]["ConnectorVersion"]).ToString();
                assemblyInstallationFolder = (dtConfigurationSettings.Rows[0]["AssemblyPath"]).ToString();
                fileExportFolderFromSQLServer = (dtConfigurationSettings.Rows[0]["ExportPath"]).ToString();
                fileImportFolderFromSQLServer = (dtConfigurationSettings.Rows[0]["ImportPath"]).ToString();
                mFilesClientInstallationVersionOnSQLServer = (dtConfigurationSettings.Rows[0]["ClientVersion"]).ToString();

            }



            string licenseStatus = this.License.LicenseStatus == MFApplicationLicenseStatus.MFApplicationLicenseStatusTrial ? "Trial" : this.License.LicenseStatus == MFApplicationLicenseStatus.MFApplicationLicenseStatusValid ? "Valid" : "Invalid";



            string logo = $"<div style='background-image: url({Logo});background-repeat:no-repeat;background-position:center;height:100px;'></div>";

            string title = $"<div style='text-align:center;color:blue'>  MFSQL Database Connector</div><br/>";

            string tdStyle = "border: 1px solid black;border-collapse: collapse; width: 100px";


            string tableStyle = "border: 1px solid black;border-collapse: collapse;width:100%";

            string table = $"<table style='{tableStyle}'><tr><td style = '{tdStyle}'>License Type</td><td style = '{tdStyle}'>Expiry Date</td><td style = 'width:100px'>Modules</td></tr><tr><td style = '{tdStyle}'>{licenseStatus}</td><td style = '{tdStyle}'>{this.License.Content<MFiles.VAF.Configuration.LicenseContentBase>().LicenseExpireDate}</td><td style = '{tdStyle}'>{ModulesHtml }</td></tr></table>";

            string details = $"<ul><li>MFSQL Connector Version : {mfSqlConnectorVersion}</li><li>Name of Application : MFSQL Connector</li><li>SQL Server :{ this.config.CurrentConfiguration.ServerName}</li><li>Database :{this.config.CurrentConfiguration.DatabaseName}</li><li>MFSQL Database User : {this.config.CurrentConfiguration.UserName}</li><li>Assembly installation folder :{assemblyInstallationFolder}</li><li>File Export Folder from SQL Server :{fileExportFolderFromSQLServer}</li><li>File Import Folder from SQL Server :{fileImportFolderFromSQLServer}</li><li>M-Files Client installation version on SQL Server :{mFilesClientInstallationVersionOnSQLServer}</li></ul>";

            string footer = $"<div style='background-image: url({image});background-repeat:no-repeat;background-position:center;height:150px;background-size:auto;'></div>";


            //if (File.Exists("DashBoardContent.xml"))
            //{
            //    // Open the file to read from.
            //    string readText = File.ReadAllText("DashBoardContent.xml");

            //    XmlSerializer serializer = new XmlSerializer(typeof(XMLDashborad.DashBoardDetails));
            //    StringReader reader = new StringReader(readText);
            //    XMLDashborad.DashBoardDetails objectDetailCollection = (XMLDashborad.DashBoardDetails)serializer.Deserialize(reader);
            //    reader.Close();

            //    foreach (XMLDashborad.DashboardItem Item in objectDetailCollection.List)
            //    {
            //        Title = Item.Title;
            //        Description = Item.Description;
            //        HelpLink = Item.HelpLink;
            //        Helptext = Item.Helptext;
            //    }
            //}


            StatusDashboard dashboard;
            dashboard = new StatusDashboard()
            {
                Contents = {
                                  new DashboardPanel()
                                  {
                                         Title = "MFSQL Connector Context Menu Vault Application",
                                         Background = PanelBackground.None,
                                         Commands = {
                                                //DashboardHelper.CreateDomainCommand( "Remove Connection", "RemoveConfiguration" )
                                         },

                                       //  InnerContent = new DashboardCustomContent($"<div style='background-image: url({Logo});height:50px;display:block; margin-left:auto;margin-right: auto;width:15%; '></div><div style='height:50px;display:block; margin-left:auto;margin-right: auto;width:40%;font-family:Calibri Light (Headings);font-size: 16px;color:#2f5496'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MFSQL Database File Connector</div><br/><div style='color:black;font-family:Calibri (Body);font-size: 11px;'> The MFSQL Database File Connector is part of the MFSQL Connector suite. The Connector allows the user to browse and search in M-files to file that is saved in SQL Blobs in a SQL Table.<br/><br/> </div><br/><br/><br/><div style='background-image: url({image});height:130px;display:block; margin-left:auto;margin-right: auto;width:50%; '></div>" )
                                         InnerContent = new DashboardCustomContent($"{logo}{title}{table}{details}{footer}")
                                  }
                           }
            };
            return dashboard.ToString();
        }
        public override void StartOperations(Vault vaultPersistent)
        {

            // Evaluate the license validity.
            this.License.Evaluate(vaultPersistent, false);

            string ModuleValues = string.Empty;


            VaultName = vaultPersistent.Name;

            // Output the license status.
            switch (this.License.LicenseStatus)
            {
                case MFApplicationLicenseStatus.MFApplicationLicenseStatusTrial:
                    {
                        SysUtils.ReportToEventLog(
                        "Application is running in a trial mode.",
                        System.Diagnostics.EventLogEntryType.Warning);
                        break;
                    }
                case MFApplicationLicenseStatus.MFApplicationLicenseStatusValid:
                    {
                        SysUtils.ReportInfoToEventLog(
                        "Application is licensed.");
                        break;
                    }
                default:
                    {
                        SysUtils.ReportToEventLog(
                        $"Application is in an unexpected state: { this.License.LicenseStatus}.", EventLogEntryType.Error);
                        break;
                    }
            }
            base.StartOperations(vaultPersistent);
        }

        [VaultExtensionMethod("CheckUserContextMenuAccess", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        public string CheckUserContextMenuAccess(EventHandlerEnvironment env)
        {
           
            CheckLicenseStatus();


            string Output;
            Output = "0";
            int UserGroupID = 0;
            Menu ObjMenu = new Menu();
            UserGroupID = env.Vault.UserGroupOperations.GetUserGroupIDByAlias("UsrGrp_ContextMenu");
            if (UserGroupID > 0)
            {
                IDs Members = env.Vault.UserGroupOperations.GetUserGroup(UserGroupID).Members;
                if (Members.Count > 0)
                {
                    foreach (var item in Members)
                    {
                        if (Convert.ToInt32(item) < 0)  //Indicates that Usergroup in 
                        {
                            bool IsAccess = ObjMenu.CheckUserGroupContextMenuAccess(env.CurrentUserID, Convert.ToInt32(item) * -1, env.Vault);
                            if (IsAccess)
                            {
                                Output = "1";
                                break;
                            }

                        }
                        else
                        {

                            if (Convert.ToInt32(item) == env.CurrentUserID)
                            {
                                Output = "1";
                                break;
                            }
                            else
                            {
                                Output = env.CurrentUserID.ToString();
                            }
                        }
                    }
                }

            }

            return Output;

        }




        [VaultExtensionMethod("GetContextMenuJson", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetContextMenuJson(EventHandlerEnvironment env)
        {
            //var List= this.License.Content<LicenseContent>().Modules;
            //var List = ((MFiles.VAF.LicenseManagerBase<MFiles.VAF.Configuration.LicenseContentBase>)this.License).license.Modules;
            //this.License = ((MFiles.VAF.LicenseManagerBase<MFiles.VAF.Configuration.LicenseContentBase>)this.License);
            var List = this.License.Content<MFiles.VAF.Configuration.LicenseContentBase>().Modules;
            // This is hard-coded to show hitting the breakpoint.
            // At this point we should search the vault for the config object, extract the connection string, then search for these items.
            // TODO: Make this hit the vault.
            string ConStr = GetConnectionString();
            Menu ObjMenu = new Menu();
            string Result = ObjMenu.GetContextMenu(ConStr, env.Vault, env.CurrentUserID);
            return Result;
        }

        [VaultExtensionMethod("GetContextMenuForSelectedObject", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetContextMenuForSelectedObject(EventHandlerEnvironment env)
        {

            string Input = env.Input;
            string[] ObjectDetails = Input.Split('|');
            string ObjectID = ObjectDetails[0];
            string ObjectType = ObjectDetails[1];
            string objectVer = ObjectDetails[2];

            //Added for Task 983
            string Name = string.Empty;
            int ClassID = 0;
            ObjID Obj_ID = new ObjID() { ID = Convert.ToInt32(ObjectID), Type = Convert.ToInt32(ObjectType) };
            ObjVer ObjVer = new ObjVer() { ID = Convert.ToInt32(ObjectID), ObjID = Obj_ID, Version = Convert.ToInt32(objectVer) };
            MFilesAPI.PropertyValues m_oPropertyValues = new MFilesAPI.PropertyValues();
            m_oPropertyValues = env.Vault.ObjectPropertyOperations.GetProperties(ObjVer, true);
            //Added for Task 983

            foreach (PropertyValue pf in m_oPropertyValues)
            {
                if (pf.PropertyDef == 0)
                {
                    Name = pf.Value.DisplayValue;
                }

                if (pf.PropertyDef == 100)
                {
                    var ClassID12 = ((object[,])((MFilesAPI.TypedValueClass)pf.Value).Value)[0, 0];

                    ClassID = Convert.ToInt32(ClassID12);
                }
            }
            string ConStr = GetConnectionString();
            Menu ObjMenu = new Menu();
            string Result = ObjMenu.GetContextMenuForSelectedObject(ConStr, ObjectID, ObjectType, objectVer, Name, ClassID, env.Vault, env.CurrentUserID);
            return Result;
        }

        [VaultExtensionMethod("GetPerformActionJson", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetPerformActionJson(EventHandlerEnvironment env)
        {
            envNew = env;
            ConnectionStr = GetConnectionString();
            StrInputs = env.Input;
            BackgroundOperation operation = this.BackgroundOperations.CreateBackgroundOperation("OperationName", BackgroundOperationMethod);
            operation.RunOnce();
            return Result.Replace("\\n", "\n");
        }

        [VaultExtensionMethod("GetPerformAction", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetPerformAction(EventHandlerEnvironment env)
        {

            string[] parameters = env.Input.Split('|');
            string ConStr = GetConnectionString();
            UpdateUserIDInCurrentAction(env, ConStr, parameters[0], Convert.ToInt32(parameters[1].ToString()));
            Menu ObjMenu = new Menu();
            Result = ObjMenu.PerformAction(parameters[0], ConStr, Convert.ToInt32(parameters[1].ToString()));
            ObjMenu.UpdateLastExecutedBy(ConStr, env.CurrentUserID, Convert.ToInt32(parameters[1].ToString()));
            return Result.Replace("\\n", "\n");
        }

        [VaultExtensionMethod("GetProcessStatus", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetProcessStatus(EventHandlerEnvironment env)
        {
            Boolean Output;
            string Result = string.Empty;
            string ID = env.Input;
            //string[] Parameters = Inputs.Split('|');
            //if (Parameters.Length > 0)
            //{
            string ConStr = GetConnectionString();
            Menu ObjMenu = new Menu();
            string UserName = string.Empty;
            Output = ObjMenu.ExecuteProc(ConStr, Convert.ToInt32(ID), out UserName);
            if (Output)
            {
                Result = "Process is Already running by the user " + UserName;
            }
            else
            {
                Result = "true";
            }

            //}
            return Result;
        }
        [VaultExtensionMethod("GetPerformActionOnSelectedObjectNew", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetPerformActionOnSelectedObject(EventHandlerEnvironment env)
        {

            envNew = env;
            StrSelectedObjInput = env.Input;
            ConnectionStr = GetConnectionString();
            BackgroundOperation operation = this.BackgroundOperations.CreateBackgroundOperation("OperationName", BackgroudOperation1);
            operation.RunOnce();
            return Result.Replace("\\n", "\n");
        }

        [VaultExtensionMethod("GetPerformActionOnSelectedObjectForSynchProcess", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string GetPerformActionOnSelectedObjectForSynchProcess(EventHandlerEnvironment env)
        {

            string Result = string.Empty;
            string[] ObjectDetails = env.Input.Split('|');
            string Action = ObjectDetails[0];
            string ObjectID = ObjectDetails[1];
            string ObjectType = ObjectDetails[2];
            string objectVer = ObjectDetails[3];
            string ID = ObjectDetails[4];
            string ClassID = ObjectDetails[5];
            string ConStr = GetConnectionString();
            UpdateUserIDInCurrentAction(env, ConStr, Action, Convert.ToInt32(ID));
            Menu ObjMenu = new Menu();
            Result = ObjMenu.PerformAction(Action, ConStr, Convert.ToInt32(ObjectID), Convert.ToInt32(ObjectType), Convert.ToInt32(objectVer), Convert.ToInt32(ID), Convert.ToInt32(ClassID));
            ObjMenu.UpdateLastExecutedBy(ConStr, env.CurrentUserID, Convert.ToInt32(ID));
            return Result.Replace("\\n", "\n");
        }


        [VaultExtensionMethod("AsynchAction", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string AsynchAction(EventHandlerEnvironment env)
        {
            string Input = env.Input;
            string[] parameters = Input.Split('|');
            //  string Action = "spMFInsertStudent";
            string ConStr = GetConnectionString();
            Menu ObjMenu = new Menu();
            string Result = ObjMenu.PerformAction(parameters[0], ConStr, Convert.ToInt32(parameters[1].ToString()));


            // Simulate long-running process.
            System.Threading.Thread.Sleep(10 * 1000);

            return Result.Replace("\\n", "\n");
        }

        [VaultExtensionMethod("PerformActionMethod", RequiredVaultAccess = MFVaultAccess.MFVaultAccessNone)]
        private string PerformActionMethod(EventHandlerEnvironment env)
        {
            Menu ObjData = new Menu();
            string Result = string.Empty;

            //Get Connection string value from vault
            ObjData.ConnectionString = GetConnectionString();

            //Get input parameters from vb script
            var ObjDetails = Newtonsoft.Json.JsonConvert.DeserializeObject<ObjectDetails>(env.Input) ?? new ObjectDetails();

            // Get Stored Procedure name by ActionName and ActionType
            string ProcedureName = ObjData.GetStoredProcedureNameByContextMenuID(ObjDetails.ActionName, Convert.ToInt32(ObjDetails.ActionTypeID));
            int ContextMenuID = ObjData.GetContextMenuID(ObjDetails.ActionName, Convert.ToInt32(ObjDetails.ActionTypeID));
            if (!string.IsNullOrEmpty(ProcedureName))
            {
                switch (ObjDetails.ActionTypeID)
                {
                    case "4":  //Calling stored procedure without parameters
                        envNew = env;
                        ConnectionStr = GetConnectionString();
                        StrInputs = string.Empty;
                        StrInputs = ProcedureName + "|" + ContextMenuID.ToString();
                        BackgroundOperation operation1 = this.BackgroundOperations.CreateBackgroundOperation("OperationName", BackgroundOperationMethod);
                        operation1.RunOnce();
                        //Result = ObjData.PerformAction(ProcedureName, ObjData.ConnectionString, 0);
                        break;
                    case "5": //Calling stored procedure with parameters
                        envNew = env;
                        StrSelectedObjInput = string.Empty;
                        StrSelectedObjInput = ProcedureName + "|" + ObjDetails.ObjectID.ToString() + "|" + ObjDetails.ObjectType.ToString() + "|" + ObjDetails.Objectver.ToString() + "|" + ContextMenuID.ToString() + "|" + ObjDetails.ClassID.ToString();
                        ConnectionStr = GetConnectionString();
                        BackgroundOperation operation = this.BackgroundOperations.CreateBackgroundOperation("OperationName", BackgroudOperation1);
                        operation.RunOnce();
                        //Result = ObjData.PerformAction(ProcedureName, ObjData.ConnectionString, Convert.ToInt32(ObjDetails.ObjectID), Convert.ToInt32(ObjDetails.ObjectType), Convert.ToInt32(ObjDetails.Objectver), 0,Convert.ToInt32(ObjDetails.ClassID));
                        break;

                }
            }
            else
            {
                Result = "Procedure not found";
            }

            return Result;



        }

        private string GetConnectionString()
        {
            string Result = string.Empty;
            Result = "Data Source=" + this.config.CurrentConfiguration.ServerName + ";Initial Catalog =" + this.config.CurrentConfiguration.DatabaseName + ";User Id=" + this.config.CurrentConfiguration.UserName + ";Password=" + this.config.CurrentConfiguration.Password + ";";
            //MFilesAPI.Vault oVault = env.Vault;
            //MFilesAPI.SearchConditions oSearchConditions = new MFilesAPI.SearchConditions();
            ////' Create a search condition for the object type
            //MFilesAPI.SearchCondition oSearchCondition = new MFilesAPI.SearchCondition();

            //// ' Create a search condition for the object type id
            //int iObjectTypeId = oVault.ObjectTypeOperations.GetObjectTypeIDByAlias("oMFSQLConfiguration");
            //oSearchCondition.ConditionType = MFConditionType.MFConditionTypeEqual;
            //oSearchCondition.Expression.DataStatusValueType = MFStatusType.MFStatusTypeObjectTypeID;
            //oSearchCondition.TypedValue.SetValue(MFDataType.MFDatatypeLookup, iObjectTypeId);
            //oSearchConditions.Add(-1, oSearchCondition);

            ////' Create a search condition is not deleted
            //oSearchCondition.ConditionType = MFConditionType.MFConditionTypeEqual;
            //oSearchCondition.Expression.DataStatusValueType = MFStatusType.MFStatusTypeDeleted;
            //oSearchCondition.TypedValue.SetValue(MFDataType.MFDatatypeBoolean, false);
            //oSearchConditions.Add(-1, oSearchCondition);

            ////' By Integration Status Display = "In Epicor"
            //oSearchCondition.ConditionType = MFConditionType.MFConditionTypeEqual;
            //oSearchCondition.Expression.DataPropertyValuePropertyDef = oVault.PropertyDefOperations.GetPropertyDefIDByAlias("SettingsName");
            //oSearchCondition.TypedValue.SetValue(MFDataType.MFDatatypeText, "ConnectionString");
            //oSearchConditions.Add(-1, oSearchCondition);

            //MFilesAPI.ObjectSearchResults oSearchResults = oVault.ObjectSearchOperations.SearchForObjectsByConditionsEx(oSearchConditions, MFilesAPI.MFSearchFlags.MFSearchFlagNone, false);

            //MFilesAPI.ObjectVersions oObjectVersions = new MFilesAPI.ObjectVersions();
            //oObjectVersions = oSearchResults.GetAsObjectVersions();
            //foreach (ObjectVersion oObjectVersion in oObjectVersions)
            //{
            //    MFilesAPI.PropertyValues m_oPropertyValues = new MFilesAPI.PropertyValues();
            //    m_oPropertyValues = oVault.ObjectPropertyOperations.GetProperties(oObjectVersion.ObjVer, true);
            //    int iPropDef1 = oVault.PropertyDefOperations.GetPropertyDefIDByAlias("SettingsDetail");
            //    if (m_oPropertyValues.IndexOf(iPropDef1) != -1)
            //    {
            //        dynamic szProfVal = m_oPropertyValues.SearchForProperty(iPropDef1).TypedValue.DisplayValue;
            //        Result = szProfVal;
            //    }
            //}

            return Result;


        }



        private void BackgroundOperationMethod()
        {
            //string Input = envNew.Input;
            string[] parameters = StrInputs.Split('|');
            //  string Action = "spMFInsertStudent";
            string ConStr = ConnectionStr;
            UpdateUserIDInCurrentAction(envNew, ConnectionStr, parameters[0], Convert.ToInt32(parameters[1].ToString()));
            Menu ObjMenu = new Menu();
            Result = ObjMenu.PerformAction(parameters[0], ConStr, Convert.ToInt32(parameters[1].ToString()));
            ObjMenu.UpdateLastExecutedBy(ConStr, envNew.CurrentUserID, Convert.ToInt32(parameters[1].ToString()));
        }

        private void BackgroudOperation1()
        {
            string Result = string.Empty;
            // string Input = envNew.Input;
            //string[] ObjectDetails = Input.Split('|');
            string[] ObjectDetails = StrSelectedObjInput.Split('|');
            string Action = ObjectDetails[0];
            string ObjectID = ObjectDetails[1];
            string ObjectType = ObjectDetails[2];
            string objectVer = ObjectDetails[3];
            string ID = ObjectDetails[4];
            string ClassID = ObjectDetails[5];
            //string ConStr = GetConnectionString(envNew);
            string ConStr = ConnectionStr;
            UpdateUserIDInCurrentAction(envNew, ConnectionStr, Action, Convert.ToInt32(ID));
            Menu ObjMenu = new Menu();
            Result = ObjMenu.PerformAction(Action, ConStr, Convert.ToInt32(ObjectID), Convert.ToInt32(ObjectType), Convert.ToInt32(objectVer), Convert.ToInt32(ID), Convert.ToInt32(ClassID));
            ObjMenu.UpdateLastExecutedBy(ConStr, envNew.CurrentUserID, Convert.ToInt32(ID));
            // return Result.Replace("\\n", "\n"); // The implementation for background operation.
        }

        private void UpdateUserIDInCurrentAction(EventHandlerEnvironment env, string ConnectioString, string ActionName, int ID)
        {
            //string ConStr = GetConnectionString();
            int CurrenUserID = env.CurrentUserID;
            Menu ObjMenu = new Menu();
            Boolean Result = ObjMenu.UpdateCurrentUserIDForAction(ConnectioString, CurrenUserID, ActionName, ID);

        }

        private void UpdateMFModule(string ModuleValues, string VaultName, string LicenseExpiryDate, string constr)
        {
            //string conStr = GetConnectionStringByVault(objVault);


            try
            {
                SqlConnection objConnection = new SqlConnection();
                objConnection.ConnectionString = constr;
                objConnection.Open();
                SqlCommand Objcmd = new SqlCommand("spMFUpdateModule", objConnection);
                Objcmd.CommandTimeout = CommandtimeOut;
                Objcmd.CommandType = CommandType.StoredProcedure;
                Objcmd.Parameters.AddWithValue("@ModuleValues", ModuleValues);
                Objcmd.Parameters.AddWithValue("@VaultName", VaultName);
                Objcmd.Parameters.AddWithValue("@LicenseExpiryDate", LicenseExpiryDate);
                Objcmd.Parameters.AddWithValue("@LicenseErrorMessage", "License is not valid.");
                Objcmd.Parameters.AddWithValue("@ModuleErrorMessage", "You dont have access to this module.");

                Objcmd.ExecuteNonQuery();
                //Result = Objcmd.Parameters["@OutPut"].Value.ToString();
                objConnection.Close();
                //return Result;
            }
            catch (Exception e)
            {

            }
        }

        private string GetModules()
        {
            string ModuleValues = string.Empty;

            var modulesList = this.License.Content<MFiles.VAF.Configuration.LicenseContentBase>().Modules;

            if (modulesList != null)
            {
                foreach (var item in modulesList)
                    ModuleValues += item + ",";

                ModuleValues = ModuleValues.Remove(ModuleValues.Length - 1, 1);
                return ModuleValues;
            }
            return string.Empty;


        }
    }


    [DataContract]
    public class ObjectDetails
    {
        [DataMember(Name = "ObjectID")]
        public string ObjectID { get; set; }
        [DataMember(Name = "ObjectType")]
        public string ObjectType { get; set; }
        [DataMember(Name = "Objectver")]
        public string Objectver { get; set; }

        [DataMember(Name = "ActionName")]
        public string ActionName { get; set; }

        [DataMember(Name = "ActionTypeID")]
        public string ActionTypeID { get; set; }

        [DataMember(Name = "ClassID")]
        public string ClassID { get; set; }
    }
   
}